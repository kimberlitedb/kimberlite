name: Build FFI Library

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-ffi:
    name: Build FFI - ${{ matrix.platform.target }}
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          # Linux x86_64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            lib_name: libkimberlite_ffi.so
          # Linux aarch64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            lib_name: libkimberlite_ffi.so
          # macOS x86_64
          - os: macos-latest
            target: x86_64-apple-darwin
            lib_name: libkimberlite_ffi.dylib
          # macOS aarch64 (Apple Silicon)
          - os: macos-latest
            target: aarch64-apple-darwin
            lib_name: libkimberlite_ffi.dylib
          # Windows x86_64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            lib_name: kimberlite_ffi.dll

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - name: Verify and add Rust target
        run: rustup target add ${{ matrix.platform.target }}

      - name: Install cross-compilation tools (Linux aarch64)
        if: matrix.platform.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Configure cross-compilation linker (Linux aarch64)
        if: matrix.platform.target == 'aarch64-unknown-linux-gnu'
        run: |
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

      - name: Clear native CPU flags for cross-compilation
        # -Ctarget-cpu=native in .cargo/config.toml resolves to the host CPU, not
        # the target CPU, which breaks aarch64-unknown-linux-gnu (host is x86_64) and
        # x86_64-apple-darwin (macos-latest runners are ARM-based Apple Silicon).
        if: >-
          matrix.platform.target == 'aarch64-unknown-linux-gnu' ||
          matrix.platform.target == 'x86_64-apple-darwin'
        shell: bash
        run: echo "RUSTFLAGS=" >> $GITHUB_ENV

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-${{ matrix.platform.target }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Build FFI library
        run: cargo build --package kimberlite-ffi --target ${{ matrix.platform.target }} --release

      - name: Generate C header
        if: matrix.platform.os == 'ubuntu-latest' && matrix.platform.target == 'x86_64-unknown-linux-gnu'
        run: cargo build --package kimberlite-ffi --release

      - name: Verify library exists
        shell: bash
        run: |
          if [ -f "target/${{ matrix.platform.target }}/release/${{ matrix.platform.lib_name }}" ]; then
            echo "✓ FFI library built successfully"
            ls -lh "target/${{ matrix.platform.target }}/release/${{ matrix.platform.lib_name }}"
          else
            echo "✗ FFI library not found"
            exit 1
          fi

      - name: Upload FFI library
        uses: actions/upload-artifact@v4
        with:
          name: kimberlite-ffi-${{ matrix.platform.target }}
          path: target/${{ matrix.platform.target }}/release/${{ matrix.platform.lib_name }}
          if-no-files-found: error

      - name: Upload C header
        if: matrix.platform.os == 'ubuntu-latest' && matrix.platform.target == 'x86_64-unknown-linux-gnu'
        uses: actions/upload-artifact@v4
        with:
          name: kimberlite-ffi-header
          path: target/kimberlite-ffi.h
          if-no-files-found: ignore

  test-ffi-memory:
    name: FFI Memory Safety Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Valgrind
        run: |
          sudo apt-get update
          sudo apt-get install -y valgrind

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-valgrind-${{ hashFiles('**/Cargo.lock') }}

      - name: Build FFI library with debug info
        run: cargo build --package kimberlite-ffi

      - name: Run tests under Valgrind
        run: |
          # Note: --error-exitcode is intentionally omitted. Rust programs routinely
          # show "possibly lost" bytes in Valgrind due to thread-local storage and
          # global allocator teardown — these are false positives, not real leaks.
          # We check explicitly for "definitely lost" and "Invalid read" instead.
          cargo test --package kimberlite-ffi --no-fail-fast -- --test-threads=1 2>&1 | tee valgrind.log || true

          # Check for actual memory leaks (not "possibly lost" which are TLS false positives)
          if grep -q "definitely lost: [^0]" valgrind.log; then
            echo "✗ Memory leaks detected"
            grep "definitely lost" valgrind.log
            exit 1
          fi

          if grep -q "Invalid read" valgrind.log; then
            echo "✗ Invalid memory access detected"
            grep "Invalid read" valgrind.log
            exit 1
          fi

          # Verify all tests actually passed (separate from Valgrind exit code)
          if grep -q "FAILED" valgrind.log; then
            echo "✗ Test failures detected"
            exit 1
          fi

          echo "✓ No memory safety issues detected"
        env:
          CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUNNER: "valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes"

  test-ffi-asan:
    name: FFI AddressSanitizer Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust nightly (for ASAN)
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-asan-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests with AddressSanitizer
        run: |
          export RUSTFLAGS="-Z sanitizer=address"
          export ASAN_OPTIONS="detect_leaks=1:halt_on_error=1"
          cargo +nightly test --package kimberlite-ffi --target x86_64-unknown-linux-gnu -Z build-std -- --test-threads=1

  test-c-integration:
    name: C Integration Test
    runs-on: ubuntu-latest
    needs: build-ffi
    steps:
      - uses: actions/checkout@v4

      - name: Download FFI library
        uses: actions/download-artifact@v4
        with:
          name: kimberlite-ffi-x86_64-unknown-linux-gnu
          path: ./lib

      - name: Download C header
        id: download-header
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: kimberlite-ffi-header
          path: ./include

      - name: Check if header exists
        id: check-header
        run: |
          if [ -f ./include/kimberlite-ffi.h ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "C header not available, skipping C integration test"
          fi

      - name: Install build tools
        if: steps.check-header.outputs.exists == 'true'
        run: sudo apt-get update && sudo apt-get install -y build-essential

      - name: Create C test program
        if: steps.check-header.outputs.exists == 'true'
        run: |
          cat > test_ffi.c << 'EOF'
          #include <stdio.h>
          #include <string.h>
          #include "kimberlite-ffi.h"

          int main() {
              printf("Testing Kimberlite FFI from C...\n");

              // Test client creation
              const char* addresses[] = {"localhost:5432"};
              KmbClientConfig config = {
                  .addresses = addresses,
                  .address_count = 1,
                  .tenant_id = 1,
                  .auth_token = NULL
              };

              KmbClient* client = NULL;
              KmbError err = kmb_client_connect(&config, &client);

              if (err == KMB_OK && client != NULL) {
                  printf("✓ Client created successfully\n");
                  kmb_client_disconnect(client);
                  return 0;
              } else {
                  const char* msg = kmb_error_message(err);
                  printf("✗ Failed to create client: %s\n", msg);
                  return 1;
              }
          }
          EOF

      - name: Compile C test
        if: steps.check-header.outputs.exists == 'true'
        run: |
          gcc -I./include -L./lib -o test_ffi test_ffi.c -lkimberlite_ffi -Wl,-rpath,./lib

      - name: Run C test (expected to fail without server)
        if: steps.check-header.outputs.exists == 'true'
        run: |
          ./test_ffi || echo "Expected failure - no server running"

  test-python-sdk:
    name: Python SDK Tests
    runs-on: ${{ matrix.os }}
    needs: build-ffi
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download FFI library (Linux)
        if: runner.os == 'Linux'
        uses: actions/download-artifact@v4
        with:
          name: kimberlite-ffi-x86_64-unknown-linux-gnu
          path: sdks/python/kimberlite/lib

      - name: Download FFI library (macOS)
        if: runner.os == 'macOS'
        uses: actions/download-artifact@v4
        with:
          name: kimberlite-ffi-x86_64-apple-darwin
          path: sdks/python/kimberlite/lib

      - name: Download FFI library (Windows)
        if: runner.os == 'Windows'
        uses: actions/download-artifact@v4
        with:
          name: kimberlite-ffi-x86_64-pc-windows-msvc
          path: sdks/python/kimberlite/lib

      - name: Install Python dependencies
        working-directory: sdks/python
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run type checking
        working-directory: sdks/python
        run: mypy kimberlite

      - name: Run tests
        working-directory: sdks/python
        run: pytest --cov=kimberlite --cov-report=xml

      - name: Upload coverage
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          files: sdks/python/coverage.xml
          flags: python-sdk

  test-typescript-sdk:
    name: TypeScript SDK Tests
    runs-on: ${{ matrix.os }}
    needs: build-ffi
    strategy:
      matrix:
        # Windows excluded: ffi-napi requires node-gyp native compilation and
        # the MSVC toolchain setup needed for it is not configured in this job.
        # Node 18 LTS: compatible with ffi-napi; Node 20.20+ broke the NAPI ABI.
        os: [ubuntu-latest, macos-latest]
        node-version: ["18.x"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Download FFI library (Linux)
        if: runner.os == 'Linux'
        uses: actions/download-artifact@v4
        with:
          name: kimberlite-ffi-x86_64-unknown-linux-gnu
          path: sdks/typescript/lib

      - name: Download FFI library (macOS)
        if: runner.os == 'macOS'
        uses: actions/download-artifact@v4
        with:
          name: kimberlite-ffi-x86_64-apple-darwin
          path: sdks/typescript/lib

      - name: Download FFI library (Windows)
        if: runner.os == 'Windows'
        uses: actions/download-artifact@v4
        with:
          name: kimberlite-ffi-x86_64-pc-windows-msvc
          path: sdks/typescript/lib

      - name: Install dependencies
        working-directory: sdks/typescript
        run: npm install

      - name: Run type checking
        working-directory: sdks/typescript
        run: npm run type-check

      - name: Run tests
        working-directory: sdks/typescript
        run: npm test

      - name: Upload coverage
        if: matrix.os == 'ubuntu-latest' && matrix.node-version == '20.x'
        uses: codecov/codecov-action@v4
        with:
          files: sdks/typescript/coverage/lcov.info
          flags: typescript-sdk

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-ffi, test-ffi-memory, test-ffi-asan, test-python-sdk, test-typescript-sdk]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifact structure
        run: ls -R artifacts

      - name: Create release bundle
        run: |
          mkdir -p release

          # Copy libraries
          cp artifacts/kimberlite-ffi-x86_64-unknown-linux-gnu/libkimberlite_ffi.so release/
          cp artifacts/kimberlite-ffi-aarch64-unknown-linux-gnu/libkimberlite_ffi.so release/libkimberlite_ffi-aarch64.so
          cp artifacts/kimberlite-ffi-x86_64-apple-darwin/libkimberlite_ffi.dylib release/
          cp artifacts/kimberlite-ffi-aarch64-apple-darwin/libkimberlite_ffi.dylib release/libkimberlite_ffi-aarch64.dylib
          cp artifacts/kimberlite-ffi-x86_64-pc-windows-msvc/kimberlite_ffi.dll release/

          # Copy header (if it exists)
          if [ -f artifacts/kimberlite-ffi-header/kimberlite-ffi.h ]; then
            cp artifacts/kimberlite-ffi-header/kimberlite-ffi.h release/
          fi

          # Create archive
          cd release
          tar czf ../kimberlite-ffi-libs.tar.gz *

      - name: Upload release bundle
        uses: actions/upload-artifact@v4
        with:
          name: kimberlite-ffi-release
          path: kimberlite-ffi-libs.tar.gz
