name: Security

run-name: "Security scan '${{ github.head_ref || github.ref_name }}'"

on:
  workflow_dispatch:
  push:
    paths:
      - '**/Cargo.toml'
      - '**/Cargo.lock'
      - 'deny.toml'
      - '.github/workflows/security.yml'
    branches:
      - main
  pull_request:
    paths:
      - '**/Cargo.toml'
      - '**/Cargo.lock'
      - 'deny.toml'
      - '.github/workflows/security.yml'
  # Weekly scheduled audit
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight UTC

concurrency:
  group: ${{ github.workflow }}-${{ github.ref == 'refs/heads/main' && github.run_id || github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: read
  security-events: write

jobs:
  # ----------------------------------------
  # Dependency audit (vulnerabilities)
  # ----------------------------------------

  audit:
    name: Security audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        uses: taiki-e/install-action@cargo-audit

      - name: Run security audit
        run: |
          # Ignore advisories for transitive deps we cannot immediately update.
          # Each entry is tracked in the ROADMAP for resolution.
          #
          # RUSTSEC-2025-0141, RUSTSEC-2025-0134: pre-existing ignores
          # RUSTSEC-2026-0007: bytes < 1.11.1 (via tower-http/reqwest/opentelemetry)
          # RUSTSEC-2026-0009: time < 0.3.47, medium severity (via jsonwebtoken/printpdf)
          # RUSTSEC-2023-0089: atomic-polyfill unmaintained (via postcard/heapless)
          # RUSTSEC-2024-0436: paste unmaintained (via ratatui)
          # RUSTSEC-2026-0002: lru 0.12.5 unsound IterMut (transitive dep)
          cargo audit \
            --ignore RUSTSEC-2025-0141 \
            --ignore RUSTSEC-2025-0134 \
            --ignore RUSTSEC-2026-0007 \
            --ignore RUSTSEC-2026-0009 \
            --ignore RUSTSEC-2023-0089 \
            --ignore RUSTSEC-2024-0436 \
            --ignore RUSTSEC-2026-0002 \
            --deny warnings

  # ----------------------------------------
  # Comprehensive dependency checks
  # ----------------------------------------

  deny:
    name: Dependency checks (cargo-deny)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-deny
        uses: taiki-e/install-action@cargo-deny

      - name: Check licenses
        run: cargo deny check licenses

      - name: Check bans
        run: cargo deny check bans

      - name: Check advisories
        run: cargo deny check advisories

      - name: Check sources
        run: cargo deny check sources

  # ----------------------------------------
  # SBOM generation (Software Bill of Materials)
  # ----------------------------------------

  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout sources
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-cyclonedx
        run: cargo install cargo-cyclonedx

      - name: Generate SBOM
        run: |
          # cargo-cyclonedx outputs to bom.json by default
          cargo cyclonedx --format json
          # Find and rename the output file
          find . -name "bom.json" -type f | head -1 | xargs -I {} mv {} kimberlite.cdx.json || true
          ls -la kimberlite.cdx.json 2>/dev/null || echo "Note: SBOM file location may vary"

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v6
        with:
          name: sbom
          path: kimberlite.cdx.json
          retention-days: 90

  # ----------------------------------------
  # Supply chain security gate
  # ----------------------------------------

  security-gate:
    name: Security gate
    runs-on: ubuntu-latest
    if: always()
    needs:
      - audit
      - deny
    steps:
      - name: Check for security failures
        run: |
          results=(
            "${{ needs.audit.result }}"
            "${{ needs.deny.result }}"
          )

          failed=false
          for result in "${results[@]}"; do
            if [[ "$result" != "success" && "$result" != "skipped" ]]; then
              echo "Security check failed: $result"
              failed=true
            fi
          done

          if [[ "$failed" == "true" ]]; then
            echo "Security checks failed - review dependency vulnerabilities"
            exit 1
          else
            echo "All security checks passed"
          fi
