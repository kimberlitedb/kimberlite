name: VOPR Nightly

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  vopr-long-run:
    name: VOPR Long Run (1M iterations)
    runs-on: ubuntu-latest
    timeout-minutes: 180 # 3 hours max (build can take 50+ min from cold cache)

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@888d6deff7e64c26f9c7f72b54ebfe6c96e08c72 # stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@401aff9a7a08acb9d27b64936a90db81024cff97 # v2.8.2
        with:
          cache-on-failure: true

      - name: Build VOPR (release mode)
        run: cargo build --release -p kimberlite-sim

      - name: Run VOPR - Baseline (1M iterations)
        run: |
          mkdir -p vopr-results
          ./target/release/vopr \
            --scenario baseline \
            --iterations 1000000 \
            --json > vopr-results/baseline-1m.json
        continue-on-error: true

      - name: Run VOPR - Combined (1M iterations)
        run: |
          ./target/release/vopr \
            --scenario combined \
            --iterations 1000000 \
            --json > vopr-results/combined-1m.json
        continue-on-error: true

      - name: Run VOPR - Multi-tenant (500k iterations)
        run: |
          ./target/release/vopr \
            --scenario multi-tenant \
            --iterations 500000 \
            --json > vopr-results/multi-tenant-500k.json
        continue-on-error: true

      - name: Run VOPR - Swizzle Clogging (500k iterations)
        run: |
          ./target/release/vopr \
            --scenario swizzle \
            --iterations 500000 \
            --json > vopr-results/swizzle-500k.json
        continue-on-error: true

      # Coverage validation deferred until tools/validate-coverage.py is available
      # - name: Validate coverage thresholds
      #   run: |
      #     # Parse coverage from JSON results and check against nightly thresholds
      #     python3 tools/validate-coverage.py vopr-results/*.json
      #   continue-on-error: true

      - name: Generate coverage trend report
        run: |
          # Append results to historical trend file (artifacts only, not committed)
          mkdir -p .artifacts/vopr-trends
          DATE=$(date +%Y-%m-%d)
          echo "$DATE" >> .artifacts/vopr-trends/dates.txt
          jq -r '.coverage.fault_point_coverage' vopr-results/combined-1m.json >> .artifacts/vopr-trends/fault-coverage.txt || true
          jq -r '.coverage.invariant_executions | length' vopr-results/combined-1m.json >> .artifacts/vopr-trends/invariant-count.txt || true
          jq -r '.coverage.view_changes' vopr-results/combined-1m.json >> .artifacts/vopr-trends/view-changes.txt || true

      - name: Upload VOPR results
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        if: always()
        with:
          name: vopr-nightly-results-${{ github.run_number }}
          path: vopr-results/
          retention-days: 30

      - name: Upload coverage trends
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        if: always()
        with:
          name: vopr-coverage-trends
          path: .artifacts/vopr-trends/
          retention-days: 90

      - name: Check for failures
        run: |
          # If any VOPR run detected invariant violations, fail the job
          if grep -q '"result":"Violated"' vopr-results/*.json; then
            echo "❌ VOPR detected invariant violations!"
            exit 1
          fi
          echo "✅ All VOPR runs passed"

  vopr-determinism-check:
    name: VOPR Determinism Check
    runs-on: ubuntu-latest
    timeout-minutes: 90 # increased from 30 to accommodate cold-cache builds (~50 min)

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@888d6deff7e64c26f9c7f72b54ebfe6c96e08c72 # stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@401aff9a7a08acb9d27b64936a90db81024cff97 # v2.8.2

      - name: Build VOPR (release mode)
        run: cargo build --release -p kimberlite-sim

      - name: Run determinism checks on 10 seeds
        run: |
          mkdir -p vopr-determinism
          for seed in 42 123 456 789 1024 2048 4096 8192 16384 32768; do
            echo "Checking seed $seed..."
            ./target/release/vopr \
              --check-determinism \
              --seed $seed \
              --scenario combined \
              --iterations 10000 \
              --json > "vopr-determinism/seed-$seed.json"
          done

      - name: Upload determinism results
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        if: always()
        with:
          name: vopr-determinism-check-${{ github.run_number }}
          path: vopr-determinism/
          retention-days: 7

  vopr-coverage-enforcement:
    name: VOPR Coverage Enforcement
    runs-on: ubuntu-latest
    timeout-minutes: 90 # increased from 30 to accommodate cold-cache builds

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@888d6deff7e64c26f9c7f72b54ebfe6c96e08c72 # stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@401aff9a7a08acb9d27b64936a90db81024cff97 # v2.8.2

      - name: Build VOPR (release mode)
        run: cargo build --release -p kimberlite-sim

      - name: Run VOPR with coverage validation
        run: |
          # Run a shorter scenario for coverage validation.
          # Note: --coverage-threshold flag is planned but not yet implemented in the CLI.
          # Coverage config fields (min_fault_coverage, min_invariant_coverage) exist
          # in VoprConfig but are not yet wired to a CLI argument.
          ./target/release/vopr \
            --scenario combined \
            --iterations 100000 \
            --json > vopr-coverage.json

      - name: Check for invariant violations
        run: |
          # Fail if any invariant violations were detected
          if grep -q '"result":"Violated"' vopr-coverage.json; then
            echo "❌ VOPR detected invariant violations!"
            exit 1
          fi
          echo "✅ No invariant violations detected"

      - name: Upload coverage report
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        if: always()
        with:
          name: vopr-coverage-report-${{ github.run_number }}
          path: vopr-coverage.json
          retention-days: 30

  vopr-canary-tests:
    name: VOPR Canary Tests
    runs-on: ubuntu-latest
    timeout-minutes: 90 # increased from 20 to accommodate cold-cache release builds

    strategy:
      matrix:
        canary:
          - canary-skip-fsync
          - canary-wrong-hash
          - canary-commit-quorum
          - canary-idempotency-race
          - canary-monotonic-regression

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@888d6deff7e64c26f9c7f72b54ebfe6c96e08c72 # stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@401aff9a7a08acb9d27b64936a90db81024cff97 # v2.8.2
        with:
          cache-on-failure: true

      - name: Run VOPR with canary ${{ matrix.canary }}
        run: |
          cargo build --release --features ${{ matrix.canary }} -p kimberlite-sim

          # Run VOPR - should detect the intentional bug
          if ./target/release/vopr --scenario combined --iterations 10000; then
            echo "❌ Canary ${{ matrix.canary }} was NOT detected!"
            exit 1
          fi

          echo "✅ Canary ${{ matrix.canary }} was successfully detected"

  summary:
    name: VOPR Nightly Summary
    runs-on: ubuntu-latest
    needs: [vopr-long-run, vopr-determinism-check, vopr-coverage-enforcement, vopr-canary-tests]
    if: always()

    steps:
      - name: Check job status
        run: |
          echo "VOPR Long Run: ${{ needs.vopr-long-run.result }}"
          echo "Determinism Check: ${{ needs.vopr-determinism-check.result }}"
          echo "Coverage Enforcement: ${{ needs.vopr-coverage-enforcement.result }}"
          echo "Canary Tests: ${{ needs.vopr-canary-tests.result }}"

          # Fail if any critical job failed
          if [ "${{ needs.vopr-long-run.result }}" != "success" ] || \
             [ "${{ needs.vopr-determinism-check.result }}" != "success" ] || \
             [ "${{ needs.vopr-coverage-enforcement.result }}" != "success" ] || \
             [ "${{ needs.vopr-canary-tests.result }}" != "success" ]; then
            echo "❌ Some VOPR nightly jobs failed"
            exit 1
          fi

          echo "✅ All VOPR nightly jobs passed"
