# kimberlite-ffi

C Foreign Function Interface (FFI) for Kimberlite database.

## Overview

This crate provides a stable C ABI for building language-specific SDK wrappers. All operations from the Rust `kmb-client` are exposed as C-compatible functions with error codes and out-parameters.

## Building

```bash
cargo build -p kimberlite-ffi --release
```

This generates:
- `target/release/libkimberlite_ffi.so` (Linux)
- `target/release/libkimberlite_ffi.dylib` (macOS)
- `target/release/kimberlite_ffi.dll` (Windows)
- `kimberlite-ffi.h` (C header, auto-generated by cbindgen)

## Usage from C

```c
#include "kimberlite-ffi.h"

int main() {
    KmbClientConfig config = {
        .addresses = (const char*[]){"localhost:5432"},
        .address_count = 1,
        .tenant_id = 1,
        .auth_token = "secret",
        .client_name = "my-app",
        .client_version = "1.0.0",
    };

    KmbClient* client = NULL;
    KmbError err = kmb_client_connect(&config, &client);
    if (err != KMB_OK) {
        fprintf(stderr, "Error: %s\n", kmb_error_message(err));
        return 1;
    }

    // Create stream
    uint64_t stream_id;
    err = kmb_client_create_stream(client, "events", KMB_DATA_CLASS_PHI, &stream_id);
    if (err != KMB_OK) {
        fprintf(stderr, "Error: %s\n", kmb_error_message(err));
        kmb_client_disconnect(client);
        return 1;
    }

    // Append events
    const uint8_t* events[] = {(uint8_t*)"event1", (uint8_t*)"event2"};
    size_t lengths[] = {6, 6};
    uint64_t offset;
    err = kmb_client_append(client, stream_id, 0, events, lengths, 2, &offset);

    kmb_client_disconnect(client);
    return 0;
}
```

## Memory Management

- **Client-owned**: Results returned via `_out` parameters must be freed with `kmb_*_free()` functions
- **Library-owned**: Error messages from `kmb_error_message()` are static strings (do not free)

## Thread Safety

`KmbClient` is **NOT** thread-safe. Use separate client instances per thread or synchronize access.

## Error Handling

All functions return `KmbError` (enum):
- `KMB_OK` (0) = success
- Non-zero = error code

Get human-readable message:
```c
const char* msg = kmb_error_message(err);
```

Check if retryable:
```c
int retryable = kmb_error_is_retryable(err);
```

## Cross-Compilation

See `.github/workflows/build-ffi.yml` for CI cross-compilation setup.

Supported targets:
- `x86_64-unknown-linux-gnu`
- `aarch64-unknown-linux-gnu`
- `x86_64-apple-darwin`
- `aarch64-apple-darwin`
- `x86_64-pc-windows-msvc`

## Language Wrappers

See `sdks/` directory for language-specific SDKs that wrap this FFI:
- Python: `sdks/python/`
- TypeScript: `sdks/typescript/`
- Go: `sdks/go/`
- Java: `sdks/java/`

## Development Status

**Phase 11.1**: Foundation (in progress)
- [x] Basic FFI structure
- [x] Error codes and messages
- [ ] Connection management
- [ ] Stream operations (create, append, read)
- [ ] Query operations
- [ ] Memory safety tests (Valgrind)

See [docs/SDK.md](../../docs/SDK.md) for full roadmap.
