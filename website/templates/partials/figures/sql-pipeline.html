{# SQL → Event → Projection Pipeline Figure
   Shows developers what happens under the hood when they write SQL
   Vertical flow with animated connectors #}

<section class="interactive-section" id="sql-pipeline" aria-labelledby="sql-pipeline-heading">
  <div class="wrapper">
    <header class="interactive-section__header flow" data-space="s">
      <h2 id="sql-pipeline-heading" class="section-title">SQL to Events to Projections</h2>
      <p class="section-subtitle">
        Traditional databases hide their internals. VerityDB shows you <strong>exactly what happens</strong>
        when you execute a SQL statement.
      </p>
    </header>

    <figure
      class="interactive-section__figure"
      data-signals="{
        selectedQuery: 0,
        stage: 0,
        logPosition: 847
      }"
    >
      <header class="interactive-section__figure-header">
        <span class="interactive-section__fig-label">Fig. 7</span>
        <span class="interactive-section__fig-caption">Click Execute to see how a SQL statement becomes an immutable event.</span>
      </header>

      <div class="interactive-section__figure-content">
        <div class="sql-pipeline sql-pipeline--vertical">
          {# Stage 1: SQL Input #}
          <div class="sql-pipeline__stage">
            <div class="sql-pipeline__stage-header">
              <span class="sql-pipeline__stage-number">1</span>
              <h3 class="sql-pipeline__stage-title">SQL Statement</h3>
            </div>
            <div class="sql-pipeline__stage-content">
              {# Query selector buttons #}
              <div class="sql-pipeline__query-buttons">
                <button
                  class="sql-pipeline__query-btn"
                  data-attr:data-selected="$selectedQuery === 0"
                  data-on:click="$selectedQuery = 0; $stage = 0"
                >INSERT</button>
                <button
                  class="sql-pipeline__query-btn"
                  data-attr:data-selected="$selectedQuery === 1"
                  data-on:click="$selectedQuery = 1; $stage = 0"
                >UPDATE</button>
                <button
                  class="sql-pipeline__query-btn"
                  data-attr:data-selected="$selectedQuery === 2"
                  data-on:click="$selectedQuery = 2; $stage = 0"
                >SELECT</button>
              </div>

              <div class="sql-pipeline__code-block">
                <pre data-show="$selectedQuery === 0">INSERT INTO patients (id, name)
VALUES (1, 'Jane');</pre>
                <pre data-show="$selectedQuery === 1">UPDATE patients
SET name = 'Jane Doe'
WHERE id = 1;</pre>
                <pre data-show="$selectedQuery === 2">SELECT * FROM patients
WHERE id = 1;</pre>
              </div>

              <button
                class="interactive-button sql-pipeline__execute-btn"
                data-variant="primary"
                data-show="$stage === 0"
                data-on:click="$stage = 1; $logPosition = $logPosition + 1"
              >
                Execute
              </button>
            </div>
          </div>

          {# Arrow down #}
          <div class="sql-pipeline__arrow" data-attr:data-active="$stage >= 1">
            <svg viewBox="0 0 24 40" aria-hidden="true">
              <line x1="12" y1="0" x2="12" y2="32" stroke-dasharray="4 3" />
              <polygon points="6,30 12,40 18,30" />
            </svg>
          </div>

          {# Stage 2: Event Structure #}
          <div class="sql-pipeline__stage" data-attr:data-visible="$stage >= 1">
            <div class="sql-pipeline__stage-header">
              <span class="sql-pipeline__stage-number">2</span>
              <h3 class="sql-pipeline__stage-title">Event Structure</h3>
            </div>
            <div class="sql-pipeline__stage-content">
              <div class="sql-pipeline__event-card">
                <div class="sql-pipeline__event-header">
                  <span class="sql-pipeline__event-type" data-text="$selectedQuery === 0 ? 'INSERT' : ($selectedQuery === 1 ? 'UPDATE' : 'SELECT')">INSERT</span>
                  <span class="sql-pipeline__event-offset" data-text="'#' + $logPosition">#848</span>
                </div>
                <pre class="sql-pipeline__event-json">{
  "type": "<span data-text="$selectedQuery === 0 ? 'INSERT' : ($selectedQuery === 1 ? 'UPDATE' : 'SELECT')">INSERT</span>",
  "table": "patients",
  "data": { "id": 1, "name": "<span data-text="$selectedQuery === 1 ? 'Jane Doe' : 'Jane'">Jane</span>" },
  "hash": "a3f2b1c9...",
  "prev": "7f8a9b2c..."
}</pre>
              </div>

              <button
                class="interactive-button"
                data-variant="primary"
                data-show="$stage === 1"
                data-on:click="$stage = 2"
              >
                Commit to Log
              </button>
            </div>
          </div>

          {# Arrow down #}
          <div class="sql-pipeline__arrow" data-attr:data-active="$stage >= 2">
            <svg viewBox="0 0 24 40" aria-hidden="true">
              <line x1="12" y1="0" x2="12" y2="32" stroke-dasharray="4 3" />
              <polygon points="6,30 12,40 18,30" />
            </svg>
          </div>

          {# Stage 3: Projection View #}
          <div class="sql-pipeline__stage" data-attr:data-visible="$stage >= 2">
            <div class="sql-pipeline__stage-header">
              <span class="sql-pipeline__stage-number">3</span>
              <h3 class="sql-pipeline__stage-title">Projection View</h3>
            </div>
            <div class="sql-pipeline__stage-content">
              <table class="sql-pipeline__table">
                <thead>
                  <tr>
                    <th>id</th>
                    <th>name</th>
                    <th>_offset</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="sql-pipeline__row--highlight">
                    <td>1</td>
                    <td data-text="$selectedQuery === 1 ? 'Jane Doe' : 'Jane'">Jane</td>
                    <td data-text="'#' + $logPosition">#848</td>
                  </tr>
                </tbody>
              </table>

              <div class="sql-pipeline__result">
                <span class="sql-pipeline__result-icon">&#10003;</span>
                <span>Query complete. Log position: <strong data-text="$logPosition">848</strong></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="interactive-section__figure-footer cluster">
        <button
          class="interactive-button"
          data-on:click="$stage = 0; $selectedQuery = 0; $logPosition = 847"
        >
          Reset
        </button>
      </div>
    </figure>
  </div>
</section>
