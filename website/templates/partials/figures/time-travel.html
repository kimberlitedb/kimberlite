{# Time Travel Query Explorer Figure
   Analog lab clock for point-in-time queries
   Drag hands to rewind state #}

<section class="interactive-section" id="time-travel" aria-labelledby="time-travel-heading">
  <div class="wrapper">
    <header class="interactive-section__header flow" data-space="s">
      <h2 id="time-travel-heading" class="section-title">Time Travel Query Explorer</h2>
      <p class="section-subtitle">
        Drag the clock hand to travel through time.
        <strong>Every past state is perfectly reconstructable.</strong>
      </p>
    </header>

    <figure
      class="interactive-section__figure"
      data-signals="{
        position: 100,
        maxPosition: 100,
        isDragging: false,
        rows: [
          { id: 1, name: 'Jane Doe', status: 'active', appearsAt: 20, nameAt80: 'J. Doe', statusAt50: 'pending' },
          { id: 2, name: 'John Smith', status: 'active', appearsAt: 40, nameAt80: 'John Smith', statusAt50: 'active' },
          { id: 3, name: 'Alice Brown', status: 'deleted', appearsAt: 60, deletedAt: 90 }
        ]
      }"
    >
      <header class="interactive-section__figure-header">
        <span class="interactive-section__fig-label">Fig. 8</span>
        <span class="interactive-section__fig-caption">Drag the clock hand counter-clockwise to rewind. Watch rows appear and values change.</span>
      </header>

      <div class="interactive-section__figure-content">
        <div class="time-travel">
          {# Clock Panel #}
          <div class="time-travel__clock-panel">
            <div
              class="lab-clock"
              data-variant="time-travel"
              data-attr:data-dragging="$isDragging"
            >
              <span class="lab-clock__now-marker">Now</span>

              <div class="lab-clock__face">
                {# Tick marks SVG #}
                <svg class="lab-clock__ticks" viewBox="0 0 100 100">
                  {# 60 tick marks - major every 10 #}
                  <line x1="50.0" y1="10.0" x2="50.0" y2="3.0" class="lab-clock__tick--major" />
                  <line x1="54.5" y1="7.2" x2="54.9" y2="3.3" class="lab-clock__tick--minor" />
                  <line x1="58.9" y1="7.9" x2="59.8" y2="4.0" class="lab-clock__tick--minor" />
                  <line x1="63.3" y1="9.1" x2="64.5" y2="5.3" class="lab-clock__tick--minor" />
                  <line x1="67.5" y1="10.7" x2="69.1" y2="7.1" class="lab-clock__tick--minor" />
                  <line x1="71.5" y1="12.8" x2="73.5" y2="9.3" class="lab-clock__tick--minor" />
                  <line x1="75.3" y1="15.2" x2="77.6" y2="12.0" class="lab-clock__tick--minor" />
                  <line x1="78.8" y1="18.0" x2="81.4" y2="15.1" class="lab-clock__tick--minor" />
                  <line x1="82.0" y1="21.2" x2="84.9" y2="18.6" class="lab-clock__tick--minor" />
                  <line x1="84.8" y1="24.7" x2="88.0" y2="22.4" class="lab-clock__tick--minor" />
                  <line x1="84.6" y1="30.0" x2="90.7" y2="26.5" class="lab-clock__tick--major" />
                  <line x1="89.3" y1="32.5" x2="92.9" y2="30.9" class="lab-clock__tick--minor" />
                  <line x1="90.9" y1="36.7" x2="94.7" y2="35.5" class="lab-clock__tick--minor" />
                  <line x1="92.1" y1="41.1" x2="96.0" y2="40.2" class="lab-clock__tick--minor" />
                  <line x1="92.8" y1="45.5" x2="96.7" y2="45.1" class="lab-clock__tick--minor" />
                  <line x1="93.0" y1="50.0" x2="97.0" y2="50.0" class="lab-clock__tick--minor" />
                  <line x1="92.8" y1="54.5" x2="96.7" y2="54.9" class="lab-clock__tick--minor" />
                  <line x1="92.1" y1="58.9" x2="96.0" y2="59.8" class="lab-clock__tick--minor" />
                  <line x1="90.9" y1="63.3" x2="94.7" y2="64.5" class="lab-clock__tick--minor" />
                  <line x1="89.3" y1="67.5" x2="92.9" y2="69.1" class="lab-clock__tick--minor" />
                  <line x1="84.6" y1="70.0" x2="90.7" y2="73.5" class="lab-clock__tick--major" />
                  <line x1="84.8" y1="75.3" x2="88.0" y2="77.6" class="lab-clock__tick--minor" />
                  <line x1="82.0" y1="78.8" x2="84.9" y2="81.4" class="lab-clock__tick--minor" />
                  <line x1="78.8" y1="82.0" x2="81.4" y2="84.9" class="lab-clock__tick--minor" />
                  <line x1="75.3" y1="84.8" x2="77.6" y2="88.0" class="lab-clock__tick--minor" />
                  <line x1="71.5" y1="87.2" x2="73.5" y2="90.7" class="lab-clock__tick--minor" />
                  <line x1="67.5" y1="89.3" x2="69.1" y2="92.9" class="lab-clock__tick--minor" />
                  <line x1="63.3" y1="90.9" x2="64.5" y2="94.7" class="lab-clock__tick--minor" />
                  <line x1="58.9" y1="92.1" x2="59.8" y2="96.0" class="lab-clock__tick--minor" />
                  <line x1="54.5" y1="92.8" x2="54.9" y2="96.7" class="lab-clock__tick--minor" />
                  <line x1="50.0" y1="90.0" x2="50.0" y2="97.0" class="lab-clock__tick--major" />
                  <line x1="45.5" y1="92.8" x2="45.1" y2="96.7" class="lab-clock__tick--minor" />
                  <line x1="41.1" y1="92.1" x2="40.2" y2="96.0" class="lab-clock__tick--minor" />
                  <line x1="36.7" y1="90.9" x2="35.5" y2="94.7" class="lab-clock__tick--minor" />
                  <line x1="32.5" y1="89.3" x2="30.9" y2="92.9" class="lab-clock__tick--minor" />
                  <line x1="28.5" y1="87.2" x2="26.5" y2="90.7" class="lab-clock__tick--minor" />
                  <line x1="24.7" y1="84.8" x2="22.4" y2="88.0" class="lab-clock__tick--minor" />
                  <line x1="21.2" y1="82.0" x2="18.6" y2="84.9" class="lab-clock__tick--minor" />
                  <line x1="18.0" y1="78.8" x2="15.1" y2="81.4" class="lab-clock__tick--minor" />
                  <line x1="15.2" y1="75.3" x2="12.0" y2="77.6" class="lab-clock__tick--minor" />
                  <line x1="15.4" y1="70.0" x2="9.3" y2="73.5" class="lab-clock__tick--major" />
                  <line x1="10.7" y1="67.5" x2="7.1" y2="69.1" class="lab-clock__tick--minor" />
                  <line x1="9.1" y1="63.3" x2="5.3" y2="64.5" class="lab-clock__tick--minor" />
                  <line x1="7.9" y1="58.9" x2="4.0" y2="59.8" class="lab-clock__tick--minor" />
                  <line x1="7.2" y1="54.5" x2="3.3" y2="54.9" class="lab-clock__tick--minor" />
                  <line x1="7.0" y1="50.0" x2="3.0" y2="50.0" class="lab-clock__tick--minor" />
                  <line x1="7.2" y1="45.5" x2="3.3" y2="45.1" class="lab-clock__tick--minor" />
                  <line x1="7.9" y1="41.1" x2="4.0" y2="40.2" class="lab-clock__tick--minor" />
                  <line x1="9.1" y1="36.7" x2="5.3" y2="35.5" class="lab-clock__tick--minor" />
                  <line x1="10.7" y1="32.5" x2="7.1" y2="30.9" class="lab-clock__tick--minor" />
                  <line x1="15.4" y1="30.0" x2="9.3" y2="26.5" class="lab-clock__tick--major" />
                  <line x1="15.2" y1="24.7" x2="12.0" y2="22.4" class="lab-clock__tick--minor" />
                  <line x1="18.0" y1="21.2" x2="15.1" y2="18.6" class="lab-clock__tick--minor" />
                  <line x1="21.2" y1="18.0" x2="18.6" y2="15.1" class="lab-clock__tick--minor" />
                  <line x1="24.7" y1="15.2" x2="22.4" y2="12.0" class="lab-clock__tick--minor" />
                  <line x1="28.5" y1="12.8" x2="26.5" y2="9.3" class="lab-clock__tick--minor" />
                  <line x1="32.5" y1="10.7" x2="30.9" y2="7.1" class="lab-clock__tick--minor" />
                  <line x1="36.7" y1="9.1" x2="35.5" y2="5.3" class="lab-clock__tick--minor" />
                  <line x1="41.1" y1="7.9" x2="40.2" y2="4.0" class="lab-clock__tick--minor" />
                  <line x1="45.5" y1="7.2" x2="45.1" y2="3.3" class="lab-clock__tick--minor" />
                </svg>

                {# Crosshairs SVG #}
                <svg class="lab-clock__crosshairs" viewBox="0 0 100 100">
                  <line x1="50" y1="15" x2="50" y2="85" />
                  <line x1="15" y1="50" x2="85" y2="50" />
                </svg>

                {# Position numbers #}
                <div class="lab-clock__numbers">
                  <span class="lab-clock__number" data-value="0">0</span>
                  <span class="lab-clock__number" data-value="25" style="top: 50%; right: 12%; transform: translateY(-50%);">25</span>
                  <span class="lab-clock__number" data-value="50" style="bottom: 12%; left: 50%; transform: translateX(-50%);">50</span>
                  <span class="lab-clock__number" data-value="75" style="top: 50%; left: 12%; transform: translateY(-50%);">75</span>
                  <span class="lab-clock__number" data-value="100" style="top: 8%; left: 50%; transform: translateX(-50%);">100</span>
                </div>

                {# Clock hand #}
                <div
                  class="lab-clock__hand lab-clock__hand--main"
                  data-attr:style="'transform: rotate(' + ($position / $maxPosition * 360) + 'deg)'"
                ></div>

                {# Center dot #}
                <div class="lab-clock__center"></div>
              </div>

              {# Invisible interaction area for dragging #}
              <div
                class="lab-clock__interaction"
                data-on:pointerdown="
                  $isDragging = true;
                  evt.target.setPointerCapture(evt.pointerId);
                "
                data-on:pointermove="
                  if (!$isDragging) return;
                  const rect = evt.currentTarget.parentElement.getBoundingClientRect();
                  const cx = rect.left + rect.width / 2;
                  const cy = rect.top + rect.height / 2;
                  const dx = evt.clientX - cx;
                  const dy = evt.clientY - cy;
                  let angle = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
                  if (angle < 0) angle += 360;
                  $position = Math.round((angle / 360) * $maxPosition);
                "
                data-on:pointerup="
                  $isDragging = false;
                  evt.target.releasePointerCapture(evt.pointerId);
                "
                data-on:pointercancel="
                  $isDragging = false;
                "
                aria-label="Drag to change position"
                role="slider"
                aria-valuemin="0"
                aria-valuemax="100"
                data-attr:aria-valuenow="$position"
              ></div>
            </div>

            {# Position readout #}
            <div class="lab-clock__readout">
              <span class="lab-clock__readout-label">Log Position</span>
              <output class="lab-clock__readout-value" data-text="$position">100</output>
            </div>

            {# Quick navigation buttons #}
            <div class="time-travel__quick-nav cluster">
              <button class="interactive-button" data-on:click="$position = 0">Start</button>
              <button class="interactive-button" data-on:click="$position = 50">Midpoint</button>
              <button class="interactive-button" data-variant="primary" data-on:click="$position = 100">Now</button>
            </div>
          </div>

          {# Results Panel #}
          <div class="time-travel__results-panel">
            <header class="time-travel__results-header">
              <h3 class="time-travel__results-title">Query Results</h3>
              <span class="time-travel__results-badge" data-text="'AS OF Position #' + $position">AS OF Position #100</span>
            </header>

            <div class="time-travel__query">
              <code>SELECT * FROM patients AS OF POSITION <span data-text="$position">100</span>;</code>
            </div>

            <table class="time-travel__table">
              <thead>
                <tr>
                  <th>id</th>
                  <th>name</th>
                  <th>status</th>
                </tr>
              </thead>
              <tbody>
                {# Row 1: Jane Doe - appears at 20, name changes at 80, status changes at 50 #}
                <tr
                  data-show="$position >= 20"
                  data-attr:class="$position >= 20 && $position < 30 ? 'time-travel__row--new' : ''"
                >
                  <td>1</td>
                  <td data-text="$position >= 80 ? 'Jane Doe' : 'J. Doe'">Jane Doe</td>
                  <td data-text="$position >= 50 ? 'active' : 'pending'">active</td>
                </tr>

                {# Row 2: John Smith - appears at 40 #}
                <tr
                  data-show="$position >= 40"
                  data-attr:class="$position >= 40 && $position < 50 ? 'time-travel__row--new' : ''"
                >
                  <td>2</td>
                  <td>John Smith</td>
                  <td>active</td>
                </tr>

                {# Row 3: Alice Brown - appears at 60, deleted at 90 (reappears when going back) #}
                <tr
                  data-show="$position >= 60 && $position < 90"
                  data-attr:class="($position >= 60 && $position < 70) ? 'time-travel__row--new' : ($position >= 85 ? 'time-travel__row--will-delete' : '')"
                >
                  <td>3</td>
                  <td>Alice Brown</td>
                  <td>active</td>
                </tr>
              </tbody>
            </table>

            <div class="time-travel__hint" data-show="$position < 90 && $position >= 60">
              <em>Alice Brown was deleted at position #90 - but here she still exists!</em>
            </div>

            <div class="time-travel__hint" data-show="$position < 20">
              <em>No records exist yet. Move forward to see data appear.</em>
            </div>

            <div class="time-travel__row-count">
              <span data-text="($position >= 60 && $position < 90) ? '3 rows' : ($position >= 40 ? '2 rows' : ($position >= 20 ? '1 row' : '0 rows'))">3 rows</span>
            </div>
          </div>
        </div>
      </div>

      <div class="interactive-section__figure-footer cluster">
        <div class="interactive-section__legend">
          <span class="legend-item">
            <span class="legend-swatch" data-state="valid"></span>
            Active Row
          </span>
          <span class="legend-item">
            <span class="legend-swatch" data-state="invalid"></span>
            Deleted (recoverable)
          </span>
        </div>
      </div>
    </figure>
  </div>
</section>
